name: Joint Level DBQ Report Publisher

on:
  workflow_dispatch:
  schedule:
    # 07:10 America/Los_Angeles (DST-safe via dual UTC triggers + runtime hour guard)
    - cron: "10 14 * * *"
    - cron: "10 15 * * *"

concurrency:
  group: joint-level-dbq-report
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Gate scheduled run to 07:10 PT
        id: gate
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          PT_HOUR="$(TZ=America/Los_Angeles date +%H)"
          if [[ "$PT_HOUR" == "07" ]]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate required secrets
        if: steps.gate.outputs.should_run == 'true'
        env:
          ATLASSIAN_EMAIL: ${{ secrets.ATLASSIAN_EMAIL }}
          ATLASSIAN_API_TOKEN: ${{ secrets.ATLASSIAN_API_TOKEN }}
        run: |
          [[ -n "$ATLASSIAN_EMAIL" ]] || { echo "Missing secret: ATLASSIAN_EMAIL"; exit 2; }
          [[ -n "$ATLASSIAN_API_TOKEN" ]] || { echo "Missing secret: ATLASSIAN_API_TOKEN"; exit 2; }

      - name: Publish Joint Level DBQ report
        if: steps.gate.outputs.should_run == 'true'
        env:
          MPLCONFIGDIR: /tmp/mplconfig
          ATLASSIAN_EMAIL: ${{ secrets.ATLASSIAN_EMAIL }}
          ATLASSIAN_API_TOKEN: ${{ secrets.ATLASSIAN_API_TOKEN }}
          JIRA_EMAIL: ${{ secrets.ATLASSIAN_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.ATLASSIAN_API_TOKEN }}
          JIRA_URL: ${{ vars.JIRA_URL }}
          CONFLUENCE_BASE_URL: ${{ vars.CONFLUENCE_BASE_URL }}
          JOINT_LEVEL_DBQ_PAGE_ID: ${{ vars.JOINT_LEVEL_DBQ_PAGE_ID }}
          CONFLUENCE_JIRA_SERVER_NAME: ${{ vars.CONFLUENCE_JIRA_SERVER_NAME }}
          CONFLUENCE_JIRA_SERVER_ID: ${{ vars.CONFLUENCE_JIRA_SERVER_ID }}
        shell: bash
        run: |
          mkdir -p "$MPLCONFIGDIR"
          JIRA_URL_USE="${JIRA_URL:-https://halodi.atlassian.net/jira/software/projects/DQB/list}"
          CONFLUENCE_BASE_USE="${CONFLUENCE_BASE_URL:-https://halodi.atlassian.net/wiki}"
          PAGE_ID_USE="${JOINT_LEVEL_DBQ_PAGE_ID:-5691277356}"

          ARGS=(
            run_joint_level_dbq_report.py
            --jira-url "$JIRA_URL_USE"
            --publish-confluence
            --confluence-base "$CONFLUENCE_BASE_USE"
            --page-id "$PAGE_ID_USE"
            --timeout-sec 180
            --fetch-retries 8
            --retry-backoff-sec 3
          )
          if [[ -n "${CONFLUENCE_JIRA_SERVER_NAME:-}" ]]; then
            ARGS+=(--jira-server-name "$CONFLUENCE_JIRA_SERVER_NAME")
          fi
          if [[ -n "${CONFLUENCE_JIRA_SERVER_ID:-}" ]]; then
            ARGS+=(--jira-server-id "$CONFLUENCE_JIRA_SERVER_ID")
          fi

          python "${ARGS[@]}"

      - name: Skip (outside PT target hour)
        if: steps.gate.outputs.should_run != 'true'
        run: echo "Skipping this UTC trigger; not 07:xx in America/Los_Angeles."
